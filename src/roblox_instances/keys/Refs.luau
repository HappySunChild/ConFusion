local calc = require("../../core_calc/types")
local instances = require("../types")

local External = require("../../core_external/External")
local SpecialKey = require("../SpecialKey")
local xtypeof = require("../../core_graph/xtypeof")

type OneOrMore<T> = T | { T }

local function process_ref(instance: Instance, ref: OneOrMore<calc.Value<Instance>>)
	local ref_type = xtypeof(ref)

	if ref_type == "State" and ref.kind == "Value" then
		ref = ref :: calc.Value<Instance>
		ref:set(instance)

		return
	elseif ref_type == "table" then
		for _, sub_ref in ref do
			process_ref(sub_ref, instance)
		end

		return
	end

	External.log_error(instances.invalid_ref_type, nil, ref_type)
end

local Refs = SpecialKey(
	"self",
	"Refs",
	function(scope, apply_to: Instance, root_ref: OneOrMore<calc.Value<Instance>>)
		process_ref(apply_to, root_ref)
	end
)

return Refs
